# CD Pipeline - Deploy to AWS
# Deploys to EC2 via SSM on push to main
# DevOps Engineer: Naeem Dosh

name: CD - Deploy to AWS

on:
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'

  # Allow manual deployment
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production

env:
  AWS_REGION: us-east-2
  EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}

jobs:
  # Run CI first
  ci:
    name: Run CI Checks
    uses: ./.github/workflows/ci.yml

  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: ci
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify EC2 instance is running
        run: |
          INSTANCE_STATE=$(aws ec2 describe-instances \
            --instance-ids ${{ env.EC2_INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].State.Name' \
            --output text \
            --region ${{ env.AWS_REGION }})

          echo "Instance state: $INSTANCE_STATE"

          if [ "$INSTANCE_STATE" != "running" ]; then
            echo "ERROR: EC2 instance is not running!"
            exit 1
          fi

      - name: Deploy via SSM
        run: |
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids "${{ env.EC2_INSTANCE_ID }}" \
            --document-name "AWS-RunShellScript" \
            --comment "GitHub Actions Deploy - ${{ github.sha }}" \
            --parameters 'commands=[
              "set -e",
              "echo \"========================================\"",
              "echo \"Deploying commit: ${{ github.sha }}\"",
              "echo \"Branch: ${{ github.ref_name }}\"",
              "echo \"Triggered by: ${{ github.actor }}\"",
              "echo \"Time: $(date)\"",
              "echo \"========================================\"",
              "",
              "cd /app",
              "",
              "echo \"Step 1: Pulling latest code...\"",
              "git fetch origin main",
              "git reset --hard origin/main",
              "",
              "echo \"Step 2: Installing composer dependencies...\"",
              "docker run --rm -v $(pwd)/src:/app -w /app composer:latest install --no-dev --optimize-autoloader 2>&1 || true",
              "",
              "echo \"Step 3: Building Docker images...\"",
              "docker build -t app-php -f docker/php/Dockerfile .",
              "",
              "echo \"Step 4: Restarting containers...\"",
              "docker-compose -f docker-compose.prod.yml down 2>/dev/null || true",
              "docker-compose -f docker-compose.prod.yml up -d",
              "",
              "echo \"Step 5: Waiting for containers to start...\"",
              "sleep 10",
              "",
              "echo \"Step 6: Health check...\"",
              "docker-compose -f docker-compose.prod.yml ps 2>/dev/null || docker ps",
              "",
              "echo \"Step 7: Verify application is responding...\"",
              "curl -s -o /dev/null -w \"HTTP Status: %{http_code}\" http://localhost:80 || echo \"Health check pending...\"",
              "",
              "echo \"========================================\"",
              "echo \"Deployment completed successfully!\"",
              "echo \"Commit: ${{ github.sha }}\"",
              "echo \"Time: $(date)\"",
              "echo \"========================================\""
            ]' \
            --region ${{ env.AWS_REGION }} \
            --output text \
            --query 'Command.CommandId')

          echo "SSM Command ID: $COMMAND_ID"

          # Wait for command to complete
          echo "Waiting for deployment to complete..."
          aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ env.EC2_INSTANCE_ID }}" \
            --region ${{ env.AWS_REGION }} 2>/dev/null || true

          # Get command output
          RESULT=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id "${{ env.EC2_INSTANCE_ID }}" \
            --region ${{ env.AWS_REGION }})

          STATUS=$(echo "$RESULT" | jq -r '.Status')
          OUTPUT=$(echo "$RESULT" | jq -r '.StandardOutputContent')
          ERROR=$(echo "$RESULT" | jq -r '.StandardErrorContent')

          echo "Deployment Status: $STATUS"
          echo "--- Output ---"
          echo "$OUTPUT"

          if [ -n "$ERROR" ] && [ "$ERROR" != "" ]; then
            echo "--- Errors ---"
            echo "$ERROR"
          fi

          if [ "$STATUS" != "Success" ]; then
            echo "Deployment failed!"
            exit 1
          fi

      - name: Deployment Summary
        if: success()
        run: |
          echo "## Deployment Successful! ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Detail | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Region** | ${{ env.AWS_REGION }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Instance** | ${{ env.EC2_INSTANCE_ID }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Application** | https://taxplanner.app |" >> $GITHUB_STEP_SUMMARY

      - name: Deployment Failed
        if: failure()
        run: |
          echo "## Deployment Failed! ❌" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the deployment logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Troubleshooting:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Check EC2 instance is running" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify SSM agent is active" >> $GITHUB_STEP_SUMMARY
          echo "3. Check CloudWatch logs: \`/hipaa-poc/application\`" >> $GITHUB_STEP_SUMMARY
